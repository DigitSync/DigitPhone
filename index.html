<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DigitPhone Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        /* Wallpaper Transition */
        #wallpaper-layer { transition: background-image 0.5s ease-in-out; }

        /* Glass Effects */
        .glass { background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .glass-dark { background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(25px); border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        
        /* Animations */
        .app-icon { box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); transition: transform 0.1s; }
        .app-icon:active { transform: scale(0.9); filter: brightness(0.8); }
        
        #control-center { transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); will-change: transform; }
        
        /* App Grid */
        .app-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px 10px;
            padding: 20px;
            max-width: 500px;
            margin: 0 auto;
            overflow-y: auto;
            max-height: 75vh;
            padding-bottom: 130px;
        }
        .app-grid::-webkit-scrollbar { display: none; }
        @media (min-width: 768px) { .app-grid { grid-template-columns: repeat(6, 1fr); max-width: 800px; gap: 40px 30px; } }

        /* Modals */
        .app-modal { transition: transform 0.3s ease, opacity 0.3s ease; transform: scale(0.95); opacity: 0; pointer-events: none; }
        .app-modal.active { transform: scale(1); opacity: 1; pointer-events: all; }
        
        /* Chat Bubbles (AI) */
        .chat-msg { max-width: 80%; padding: 10px 14px; border-radius: 18px; margin-bottom: 8px; font-size: 14px; line-height: 1.4; }
        .chat-user { background: #3b82f6; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .chat-ai { background: #333; color: white; align-self: flex-start; border-bottom-left-radius: 4px; }
        
        /* Loading Dot Animation */
        .typing-dot { width: 6px; height: 6px; background: #bbb; border-radius: 50%; display: inline-block; animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* Utilities */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="h-screen w-screen relative overflow-hidden text-white bg-black">

    <!-- 1. WALLPAPER LAYER -->
    <div id="wallpaper-layer" class="absolute inset-0 z-0 bg-cover bg-center" 
         style="background-image: url('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=2564');">
    </div>

    <!-- 2. STATUS BAR (Click triggers Control Center) -->
    <div onclick="toggleControlCenter()" class="relative z-20 flex justify-between items-center px-6 py-2 text-sm font-medium cursor-pointer bg-gradient-to-b from-black/60 to-transparent backdrop-blur-sm">
        <div id="clock-display">12:00</div>
        <div class="flex gap-2 items-center">
            <i class="fas fa-signal"></i>
            <i class="fas fa-wifi"></i>
            <i class="fas fa-battery-full"></i>
        </div>
    </div>

    <!-- 3. CONTROL CENTER (Hidden by default) -->
    <div id="control-center" class="fixed top-0 left-0 right-0 min-h-[70vh] glass-dark z-50 rounded-b-[40px] transform -translate-y-full p-6 flex flex-col gap-6 pt-14 shadow-2xl border-b border-gray-700">
        <div class="w-12 h-1.5 bg-gray-500/50 rounded-full mx-auto mb-2"></div>
        <h2 class="text-xl font-bold px-1">Control Center</h2>
        
        <!-- Toggles -->
        <div class="grid grid-cols-2 gap-4">
            <div onclick="this.classList.toggle('bg-blue-600'); this.classList.toggle('bg-gray-700')" class="bg-blue-600 p-4 rounded-2xl flex flex-col gap-2 cursor-pointer transition-colors">
                <i class="fas fa-wifi text-white text-2xl"></i>
                <span class="font-medium">Wi-Fi</span>
            </div>
            <div onclick="this.classList.toggle('bg-blue-600'); this.classList.toggle('bg-gray-700')" class="bg-blue-600 p-4 rounded-2xl flex flex-col gap-2 cursor-pointer transition-colors">
                <i class="fab fa-bluetooth-b text-white text-2xl"></i>
                <span class="font-medium">Bluetooth</span>
            </div>
        </div>

        <!-- Wallpaper Switcher -->
        <div>
            <h3 class="text-sm font-semibold text-gray-400 mb-3 uppercase tracking-wider">Wallpapers</h3>
            <div class="flex gap-4 overflow-x-auto pb-4 scrollbar-hide">
                <div onclick="setWallpaper('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80')" class="w-20 h-32 flex-shrink-0 rounded-xl bg-cover border-2 border-white cursor-pointer hover:scale-105 transition" style="background-image: url('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80')"></div>
                <div onclick="setWallpaper('https://images.unsplash.com/photo-1550684848-fac1c5b4e853?q=80')" class="w-20 h-32 flex-shrink-0 rounded-xl bg-cover border border-transparent cursor-pointer hover:scale-105 transition" style="background-image: url('https://images.unsplash.com/photo-1550684848-fac1c5b4e853?q=80')"></div>
                <div onclick="setWallpaper('https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?q=80')" class="w-20 h-32 flex-shrink-0 rounded-xl bg-cover border border-transparent cursor-pointer hover:scale-105 transition" style="background-image: url('https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?q=80')"></div>
                <div onclick="setWallpaper('https://images.unsplash.com/photo-1579546929518-9e396f3cc809?q=80')" class="w-20 h-32 flex-shrink-0 rounded-xl bg-cover border border-transparent cursor-pointer hover:scale-105 transition" style="background-image: url('https://images.unsplash.com/photo-1579546929518-9e396f3cc809?q=80')"></div>
            </div>
        </div>

        <button onclick="toggleControlCenter()" class="mt-auto w-full bg-white/10 py-3 rounded-xl font-semibold backdrop-blur-md active:bg-white/20">Close</button>
    </div>

    <!-- 4. MAIN SCREEN -->
    <main class="relative z-10 h-full flex flex-col pt-2">
        
        <!-- Search Widget -->
        <div class="mx-6 mb-2 z-30">
            <div class="glass rounded-full px-4 py-2.5 flex items-center gap-3 shadow-lg">
                <i class="fab fa-google text-white/80"></i>
                <input type="text" id="search-input" placeholder="Search Google..." class="bg-transparent border-none outline-none text-white placeholder-white/60 w-full text-sm font-medium" onkeydown="if(event.key === 'Enter') executeSearch()">
                <i class="fas fa-search text-white/80 cursor-pointer" onclick="executeSearch()"></i>
            </div>
        </div>

        <!-- Apps Container -->
        <div class="app-grid" id="app-container">
            
            <!-- ROTATING AD WIDGET (Top) -->
            <div id="ad-widget" class="col-span-4 md:col-span-3 h-44 rounded-2xl relative overflow-hidden shadow-lg group cursor-pointer transform transition hover:scale-[1.02]" onclick="openAdLink()">
                <img id="ad-img" src="" class="absolute inset-0 w-full h-full object-cover transition-opacity duration-700">
                <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent flex flex-col justify-end p-4">
                    <span class="bg-white/20 backdrop-blur w-fit px-2 py-0.5 rounded text-[10px] font-bold mb-1">SPONSORED</span>
                    <h3 id="ad-title" class="font-bold text-lg leading-tight">Loading...</h3>
                    <p id="ad-sub" class="text-gray-300 text-xs mt-0.5">Please wait</p>
                </div>
            </div>
            
            <!-- Apps injected by JS -->
        </div>
    </main>

    <!-- 5. DOCK (Bottom Shortcuts) -->
    <div class="fixed bottom-4 left-4 right-4 h-24 glass rounded-[35px] flex justify-around items-center px-2 z-40 max-w-xl mx-auto backdrop-blur-xl border border-white/20 shadow-2xl">
        <!-- Dock items injected by JS -->
    </div>

    <!-- === APPS (Modals) === -->

    <!-- DIGIT AI APP (New Integration) -->
    <div id="app-digitai" class="app-modal fixed inset-0 z-[60] bg-[#121212] flex flex-col text-white">
        <!-- Header -->
        <div class="h-16 flex items-center justify-between px-4 border-b border-white/10 bg-[#1e1e1e]">
            <span onclick="closeAllApps()" class="text-blue-400 font-medium cursor-pointer"><i class="fas fa-chevron-left"></i> Back</span>
            <div class="flex flex-col items-center">
                <span class="font-bold text-lg flex items-center gap-2"><i class="fas fa-sparkles text-purple-400"></i> DigitAI</span>
            </div>
            <span onclick="clearChat()" class="text-gray-400 text-sm cursor-pointer">Clear</span>
        </div>
        
        <!-- Chat Area -->
        <div id="chat-container" class="flex-1 overflow-y-auto p-4 flex flex-col gap-2">
            <!-- Intro Message -->
            <div class="chat-msg chat-ai bg-gradient-to-br from-purple-700 to-indigo-700">
                Hello Boss! Main DigitAI hoon. Aaj kya banayein? ðŸ¤–
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-3 bg-[#1e1e1e] pb-8">
            <div class="flex items-center gap-2 bg-[#2c2c2c] rounded-full px-4 py-2">
                <input type="text" id="ai-input" placeholder="Ask anything..." class="bg-transparent flex-1 outline-none text-white placeholder-gray-500" onkeydown="if(event.key === 'Enter') sendAIChat()">
                <button onclick="sendAIChat()" class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white"><i class="fas fa-paper-plane text-xs"></i></button>
            </div>
        </div>
    </div>

    <!-- Calculator (With GST Features) -->
    <div id="app-calculator" class="app-modal fixed inset-0 z-[60] bg-black flex flex-col">
        <div class="flex-1 flex flex-col justify-end p-6 pb-12">
            <div class="mb-2 text-gray-400 text-right text-sm h-6" id="calc-history"></div>
            <div id="calc-display" class="text-right text-6xl font-light mb-6 truncate text-white">0</div>
            
            <!-- GST Buttons Row -->
            <div class="grid grid-cols-4 gap-3 mb-3">
                <button onclick="calcGST(12, 'add')" class="h-12 rounded-xl bg-blue-900/50 text-blue-300 text-sm font-bold">+12%</button>
                <button onclick="calcGST(18, 'add')" class="h-12 rounded-xl bg-blue-900/50 text-blue-300 text-sm font-bold">+18%</button>
                <button onclick="calcGST(12, 'sub')" class="h-12 rounded-xl bg-red-900/50 text-red-300 text-sm font-bold">-12%</button>
                <button onclick="calcGST(18, 'sub')" class="h-12 rounded-xl bg-red-900/50 text-red-300 text-sm font-bold">-18%</button>
            </div>

            <div class="grid grid-cols-4 gap-4">
                <button onclick="calcClear()" class="h-16 rounded-full bg-gray-400 text-black text-xl font-bold">AC</button>
                <button onclick="calcDel()" class="h-16 rounded-full bg-gray-400 text-black text-xl font-bold"><i class="fas fa-backspace"></i></button>
                <button onclick="calcInput('%')" class="h-16 rounded-full bg-gray-400 text-black text-xl font-bold">%</button>
                <button onclick="calcInput('/')" class="h-16 rounded-full bg-orange-500 text-white text-xl"><i class="fas fa-divide"></i></button>
                
                <button onclick="calcInput('7')" class="h-16 rounded-full bg-gray-800 text-xl">7</button>
                <button onclick="calcInput('8')" class="h-16 rounded-full bg-gray-800 text-xl">8</button>
                <button onclick="calcInput('9')" class="h-16 rounded-full bg-gray-800 text-xl">9</button>
                <button onclick="calcInput('*')" class="h-16 rounded-full bg-orange-500 text-white text-xl"><i class="fas fa-times"></i></button>
                
                <button onclick="calcInput('4')" class="h-16 rounded-full bg-gray-800 text-xl">4</button>
                <button onclick="calcInput('5')" class="h-16 rounded-full bg-gray-800 text-xl">5</button>
                <button onclick="calcInput('6')" class="h-16 rounded-full bg-gray-800 text-xl">6</button>
                <button onclick="calcInput('-')" class="h-16 rounded-full bg-orange-500 text-white text-xl"><i class="fas fa-minus"></i></button>
                
                <button onclick="calcInput('1')" class="h-16 rounded-full bg-gray-800 text-xl">1</button>
                <button onclick="calcInput('2')" class="h-16 rounded-full bg-gray-800 text-xl">2</button>
                <button onclick="calcInput('3')" class="h-16 rounded-full bg-gray-800 text-xl">3</button>
                <button onclick="calcInput('+')" class="h-16 rounded-full bg-orange-500 text-white text-xl"><i class="fas fa-plus"></i></button>
                
                <button onclick="calcInput('0')" class="h-16 rounded-full bg-gray-800 text-xl col-span-2 w-full">0</button>
                <button onclick="calcInput('.')" class="h-16 rounded-full bg-gray-800 text-xl">.</button>
                <button onclick="calcResult()" class="h-16 rounded-full bg-orange-500 text-white text-xl flex items-center justify-center"><i class="fas fa-equals"></i></button>
            </div>
        </div>
        <div onclick="closeAllApps()" class="h-12 w-full flex items-center justify-center cursor-pointer bg-black"><div class="w-32 h-1.5 bg-white rounded-full"></div></div>
    </div>

    <!-- Notes (With Magic AI) -->
    <div id="app-notes" class="app-modal fixed inset-0 z-[60] bg-[#1c1c1e] flex flex-col text-white">
        <div class="h-16 flex items-center justify-between px-4 border-b border-gray-800 bg-[#1c1c1e]">
            <span onclick="closeAllApps()" class="text-orange-400 font-medium cursor-pointer"><i class="fas fa-chevron-left"></i> Back</span>
            <span class="font-bold text-lg">Notes</span>
            <span onclick="saveNotes()" class="text-orange-400 font-medium cursor-pointer">Done</span>
        </div>

        <!-- Magic Toolbar -->
        <div class="px-4 py-2 bg-[#2c2c2e] flex gap-2 overflow-x-auto">
            <button onclick="magicNote('fix')" class="px-3 py-1 bg-purple-600/30 text-purple-300 rounded-lg text-xs font-semibold whitespace-nowrap flex items-center gap-1"><i class="fas fa-magic"></i> Professional</button>
            <button onclick="magicNote('short')" class="px-3 py-1 bg-blue-600/30 text-blue-300 rounded-lg text-xs font-semibold whitespace-nowrap flex items-center gap-1"><i class="fas fa-compress-alt"></i> Summarize</button>
            <button onclick="magicNote('list')" class="px-3 py-1 bg-green-600/30 text-green-300 rounded-lg text-xs font-semibold whitespace-nowrap flex items-center gap-1"><i class="fas fa-list"></i> Make List</button>
        </div>
        <div id="notes-loader" class="hidden px-4 py-1 text-xs text-gray-400 italic">DigitAI is thinking...</div>

        <textarea id="notes-area" class="flex-1 bg-transparent p-6 text-lg outline-none resize-none placeholder-gray-500" placeholder="Type here..."></textarea>
    </div>

    <script>
        const apiKey = ""; // API Key provided by environment

        // --- GEMINI API HELPER ---
        async function callGemini(prompt) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${AIzaSyBsdvY-yxoLMnaM8_k1fTDbvU3fI-6UPaI}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("AI Error:", error);
                return "Sorry Boss, internet issue hai shayad. Try again.";
            }
        }

        // --- 1. CONFIGURATION ---
        
        // ADS ARRAY
        const ads = [
            {
                title: "DigitMart Big Sale",
                sub: "50% Off on Mobile Accessories",
                img: "https://images.unsplash.com/photo-1607082348824-0a96f2a4b9da?q=80&w=800",
                link: "https://mybillbook.in/store/digitmart"
            },
            {
                title: "Repair Services",
                sub: "Fast & Reliable Mobile Repair",
                img: "https://images.unsplash.com/photo-1581092921461-eab62e97a783?q=80&w=800",
                link: "#"
            },
            {
                title: "New Gadgets",
                sub: "Check out latest arrivals",
                img: "https://images.unsplash.com/photo-1550009158-9ebf69173e03?q=80&w=800",
                link: "#"
            }
        ];

        // APPS LIST (Updated with New Additions)
        const apps = [
            { name: 'DigitAI', icon: 'fa-sparkles', isBrand: false, color: 'bg-gradient-to-tr from-indigo-600 to-purple-600', iconColor: 'text-white', type: 'app', id: 'digitai' },
            { name: 'ShopBook', icon: 'fa-receipt', isBrand: false, color: 'bg-orange-600', type: 'link', url: 'https://digitsync.github.io/DigitBook/' },
            { name: 'Browser', icon: 'fa-globe', isBrand: false, color: 'bg-blue-500', type: 'link', url: 'https://thedigitsync.blogspot.com/2024/11/comprehensive-file-type-search.html' },
            { name: 'Typing', icon: 'fa-keyboard', isBrand: false, color: 'bg-green-600', type: 'link', url: 'https://digitsync.github.io/Typing-master-Pro/' },
            { name: 'QRCode', icon: 'fa-qrcode', isBrand: false, color: 'bg-gray-800', type: 'link', url: 'https://digitsync.github.io/Code-Generator/' },
            
            { name: 'Bill Book', icon: 'fa-file-invoice-dollar', isBrand: false, color: 'bg-green-500', type: 'link', url: 'https://mybillbook.in/store/digitmart' },
            { name: 'Calculator', icon: 'fa-calculator', isBrand: false, color: 'bg-gray-800', iconColor: 'text-orange-500', type: 'app', id: 'calculator' },
            { name: 'Notes', icon: 'fa-sticky-note', isBrand: false, color: 'bg-yellow-400', type: 'app', id: 'notes' },
            
            { name: 'Instagram', icon: 'fa-instagram', isBrand: true, color: 'bg-gradient-to-br from-purple-500 to-pink-500', type: 'link', url: 'https://www.instagram.com/digitmartonline?igsh=YW81ZTE4NGY1Nzdu' },
            { name: 'YouTube', icon: 'fa-youtube', isBrand: true, color: 'bg-white', iconColor: 'text-red-600', type: 'link', url: 'https://youtube.com/@fearlesshacker?si=4oUBkcJHPEEKIaZt' },
            { name: 'DigitMart', icon: 'fa-store', isBrand: false, color: 'bg-blue-600', type: 'link', url: 'https://mybillbook.in/store/digitmart' },
            { name: 'Settings', icon: 'fa-cog', isBrand: false, color: 'bg-gray-500', type: 'action', action: 'toggleControlCenter' }
        ];

        const dockApps = [
            { icon: 'fa-phone', isBrand: false, color: 'bg-green-500', action: "alert('Calling Feature')" },
            { icon: 'fa-map-marker-alt', isBrand: false, color: 'bg-blue-500', url: 'https://maps.app.goo.gl/zsciQzhwYcU4MYUN9' },
            { icon: 'fa-whatsapp', isBrand: true, color: 'bg-green-600', url: 'https://wa.me/message/PERTKXM4MMF2K1' },
            { icon: 'fa-globe', isBrand: false, color: 'bg-blue-400', url: 'https://thedigitsync.blogspot.com/' }
        ];

        // --- 2. LOGIC ---

        // Render Apps
        function renderApps() {
            const container = document.getElementById('app-container');
            // Keep the ad widget
            container.innerHTML = '';
            
            // Re-add Ad Widget HTML
            const adWidgetHTML = `
            <div id="ad-widget" class="col-span-4 md:col-span-3 h-44 rounded-2xl relative overflow-hidden shadow-lg group cursor-pointer transform transition hover:scale-[1.02]" onclick="openAdLink()">
                <img id="ad-img" src="" class="absolute inset-0 w-full h-full object-cover transition-opacity duration-700">
                <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent flex flex-col justify-end p-4">
                    <span class="bg-white/20 backdrop-blur w-fit px-2 py-0.5 rounded text-[10px] font-bold mb-1">SPONSORED</span>
                    <h3 id="ad-title" class="font-bold text-lg leading-tight">Loading...</h3>
                    <p id="ad-sub" class="text-gray-300 text-xs mt-0.5">Please wait</p>
                </div>
            </div>`;
            container.innerHTML = adWidgetHTML;

            apps.forEach(app => {
                const div = document.createElement('div');
                div.className = 'flex flex-col items-center gap-1 group cursor-pointer active:scale-95 transition-transform';
                
                let action = '';
                if(app.type === 'link') action = `window.open('${app.url}', '_blank')`;
                else if(app.type === 'app') action = `openApp('${app.id}')`;
                else if(app.type === 'action') action = `${app.action}()`;

                // Fix Icon Class (fab vs fas)
                const iconClass = app.isBrand ? `fab ${app.icon}` : `fas ${app.icon}`;
                
                div.innerHTML = `
                    <div onclick="${action}" class="app-icon w-14 h-14 md:w-16 md:h-16 rounded-2xl flex items-center justify-center ${app.color} text-2xl overflow-hidden relative">
                        <i class="${iconClass} ${app.iconColor || 'text-white'}"></i>
                    </div>
                    <span class="text-xs font-medium drop-shadow-md text-center text-white">${app.name}</span>
                `;
                container.appendChild(div);
            });
        }

        function renderDock() {
            const container = document.querySelector('.fixed.bottom-4');
            container.innerHTML = ''; // Clear to be safe
            dockApps.forEach(app => {
                const div = document.createElement('div');
                let action = app.url ? `window.open('${app.url}', '_blank')` : app.action;
                const iconClass = app.isBrand ? `fab ${app.icon}` : `fas ${app.icon}`;
                
                div.innerHTML = `
                    <div onclick="${action}" class="app-icon w-14 h-14 md:w-16 md:h-16 rounded-2xl flex items-center justify-center ${app.color} cursor-pointer hover:-translate-y-2 transition-transform duration-200">
                        <i class="${iconClass} ${app.iconColor || 'text-white'} text-2xl"></i>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Ad Rotation Logic
        let currentAdIndex = 0;
        function rotateAds() {
            const ad = ads[currentAdIndex];
            const imgEl = document.getElementById('ad-img');
            const titleEl = document.getElementById('ad-title');
            const subEl = document.getElementById('ad-sub');
            
            // Fade effect
            if(imgEl) {
                imgEl.style.opacity = 0.5; 
                setTimeout(() => {
                    imgEl.src = ad.img;
                    titleEl.innerText = ad.title;
                    subEl.innerText = ad.sub;
                    imgEl.style.opacity = 1;
                }, 300);
            }
            currentAdIndex = (currentAdIndex + 1) % ads.length;
        }

        function openAdLink() {
            let idx = currentAdIndex === 0 ? ads.length - 1 : currentAdIndex - 1;
            const url = ads[idx].link;
            if(url !== '#') window.open(url, '_blank');
        }

        // Initialize
        renderApps();
        renderDock();
        rotateAds(); 
        setInterval(rotateAds, 4000); 

        // System Functions
        function updateClock() {
            const now = new Date();
            document.getElementById('clock-display').innerText = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }
        setInterval(updateClock, 1000);
        updateClock();

        function toggleControlCenter() {
            const cc = document.getElementById('control-center');
            cc.classList.toggle('-translate-y-full');
        }

        function setWallpaper(url) {
            document.getElementById('wallpaper-layer').style.backgroundImage = `url('${url}')`;
        }

        function executeSearch() {
            const q = document.getElementById('search-input').value;
            if(q) window.open(`https://www.google.com/search?q=${encodeURIComponent(q)}`, '_blank');
        }

        // Internal Apps
        function openApp(id) {
            document.getElementById(`app-${id}`).classList.add('active');
            if(id === 'notes') loadNotes();
        }
        function closeAllApps() {
            document.querySelectorAll('.app-modal').forEach(el => el.classList.remove('active'));
        }

        // --- AI LOGIC ---
        async function sendAIChat() {
            const input = document.getElementById('ai-input');
            const container = document.getElementById('chat-container');
            const text = input.value.trim();
            if(!text) return;

            container.innerHTML += `<div class="chat-msg chat-user">${text}</div>`;
            input.value = '';
            container.scrollTop = container.scrollHeight;

            const loadingId = 'loading-' + Date.now();
            container.innerHTML += `<div id="${loadingId}" class="chat-msg chat-ai"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
            container.scrollTop = container.scrollHeight;

            const reply = await callGemini(text);
            document.getElementById(loadingId).remove();
            
            const formattedReply = reply.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            container.innerHTML += `<div class="chat-msg chat-ai">${formattedReply}</div>`;
            container.scrollTop = container.scrollHeight;
        }

        function clearChat() {
            document.getElementById('chat-container').innerHTML = `
                <div class="chat-msg chat-ai bg-gradient-to-br from-purple-700 to-indigo-700">
                    Hello Boss! Main DigitAI hoon. Aaj kya banayein? ðŸ¤–
                </div>
            `;
        }

        // --- MAGIC NOTES LOGIC ---
        async function magicNote(mode) {
            const area = document.getElementById('notes-area');
            const loader = document.getElementById('notes-loader');
            const content = area.value.trim();
            
            if(!content) {
                alert("Please write something first!");
                return;
            }

            loader.classList.remove('hidden');
            let prompt = "";
            if(mode === 'fix') prompt = `Rewrite this professionally in English/Hindi mix: "${content}"`;
            if(mode === 'short') prompt = `Summarize this short and sweet: "${content}"`;
            if(mode === 'list') prompt = `Convert this into a checklist with emojis: "${content}"`;

            const result = await callGemini(prompt);
            loader.classList.add('hidden');
            
            if(result) area.value = result;
        }

        // --- CALCULATOR LOGIC (Standard + GST) ---
        let cVal = '';
        function calcInput(v) { cVal += v; document.getElementById('calc-display').innerText = cVal; }
        
        function calcClear() { 
            cVal = ''; 
            document.getElementById('calc-display').innerText = '0'; 
            document.getElementById('calc-history').innerText = '';
        }

        function calcDel() {
            cVal = cVal.toString().slice(0, -1);
            document.getElementById('calc-display').innerText = cVal || '0';
        }

        function calcResult() { 
            try { 
                document.getElementById('calc-history').innerText = cVal + ' =';
                cVal = eval(cVal).toString(); 
            } catch { 
                cVal = 'Error'; 
            } 
            document.getElementById('calc-display').innerText = cVal; 
        }

        function calcGST(rate, mode) {
            try {
                let base = parseFloat(eval(cVal)) || 0;
                let final = 0;
                if (mode === 'add') {
                    final = base + (base * rate / 100);
                    document.getElementById('calc-history').innerText = `${base} + ${rate}% GST`;
                } else {
                    final = base / (1 + (rate / 100));
                    document.getElementById('calc-history').innerText = `${base} - ${rate}% GST`;
                }
                cVal = final.toFixed(2);
                document.getElementById('calc-display').innerText = cVal;
            } catch (e) {
                cVal = 'Error';
                document.getElementById('calc-display').innerText = cVal;
            }
        }

        // Notes
        function loadNotes() { document.getElementById('notes-area').value = localStorage.getItem('digitNotes') || ''; }
        function saveNotes() { 
            localStorage.setItem('digitNotes', document.getElementById('notes-area').value); 
            closeAllApps(); 
        }

    </script>
</body>
</html>
